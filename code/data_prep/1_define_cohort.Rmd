---
title: "Maintainance of Certification and Medicare Outcomes"
subtitle: "Cohort Definition"
author: "Xilin Chen"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  comment = NA,
  message = FALSE,
  warning = FALSE,
  R.options = list(width = 220),
  dev.args = list(bg = 'transparent'),
  dev = 'png',
  layout = "l-body-outset",
  fig.align = 'center',
  out.width = '75%',
  fig.asp = .75,
  fig.pos = 'H',
  cache = FALSE, 
  cache.rebuild = TRUE
)

library(tidyverse)
library(kableExtra)
```

This document describes how the ABS maintenance of certification and medicare outcomes cohort was defined. The data will be used for further statistical analyses.

## 1. Data Sources

- ABS certification data (received at September 2019 from ABS)
- Medicare claim data
  - Year: 2007-2018
  - Procedures: commonly performed general surgery procedures (162 procedures in total)
  
ABS and Medicare claim data are linked using physician NPIs.

\pagebreak

## 2. Cohort definition diagram overview

Below is the consort diagram for the data selection process. Detailed cohort selection descriptions are included in *3. Data Process* and *4. Data linkage*. 

![](/Users/xilinchen/Documents/Repo/ABS_MoC_vs_pt_Outcome/other_docs/Diagram/cohort_definition/cohort_definition.png)

## 3. Data Process

### ABS
  

```{r, cache=TRUE}
# ABS data prep -----------------------------------------------------------
abs = data.table::fread("/Volumes/George_Surgeon_Projects/Surgeon Profile data/abs_with_npi.csv")

# nrow(abs) #51624

abs = abs %>% 
  mutate(residency_graduation_year = ifelse(!is.na(residency_yog),
                                            residency_yog, yot))
```


```{r abs_gs}
selected_abs = abs %>% 
  mutate(npi = as.character(npi),
         # initial certification
         pass_CE = ifelse(PFfirstCE == "p" | !is.na(Gcompyear), "passed", "failed")
         ) %>% 
  select(npi, sex, residency_graduation_year, Gcertyear, Gcompyear, ReCeverPassed,
         pass_CE, nAttemptsReCert, PFfirstR, us_medschool, gs_specialty_cms, fellowship) 

# filter passed initial certification -----------------------------------------------------------
abs_cert = selected_abs %>% 
  filter(pass_CE == "passed")

# nrow(abs_cert) # 45589
# filter Fellowship trained or on-us med school -----------------------------------------------------------
abs_gs = abs_cert %>% 
 filter(fellowship == "FALSE", us_medschool != "Foreign_MG" | is.na(us_medschool))

# nrow(abs_gs) #31066
n_exclude = nrow(abs_cert)-nrow(abs_gs)

# add medicare gs definition
# abs_medicare_gs = abs_gs %>% 
#   filter(gs_specialty_cms == "TRUE")
# nrow(abs_medicare_gs) #13259

```

```{r}
# 2017 as the last year
abs_gs_2017 = abs_gs %>% 
  mutate(cutoff_2007 = ifelse(Gcertyear+10>=2017, "exlcude", "include")) %>% 
  filter(cutoff_2007 == "include" | is.na(cutoff_2007))

# nrow(abs_gs) - nrow(abs_gs_2017)

```
### 3.1. Inclusion and Exclusion

Inclusion: 
 
  - Surgeons with NPI
  - Passed initial certification exam
  - Not qualified (10 years after initial certification) for exam after 2017 (exam change in 2017)
    - to address the exam changes in 2017, we excluded all surgeons who were qualified for recertification after(including) 2017. In our dataset, we don't have the recertifcation exam years for surgeons. So it's not possible to know if the surgeon took the exam before or after 2017. By excluding surgeons who were qualified to take the exam after 2017, we exclude the group who might have taken the exam after 2017. However, this also excluded some surgeons who took recertification exam earlier than 10 years after the initial certification.

Exclusion: 
 
  - Fellowship or non-US trained surgeons (n = `r n_exclude`). 
    - Fellowship and Med school information is from ABS, AMA and Fellowship Council data.
  
Below is the re-certification status for all qualified ABS surgeons. Very few surgeons have recorded failed re-certification status.  A large portion of surgeons didn't have re-certification records at all, i.e. NA.

```{r}
abs_gs_2017 %>%
  count(ReCeverPassed, name = "n suregon") %>%
  mutate(percentage = scales::percent(`n suregon` / sum(`n suregon`))) %>% 
  kable() %>% 
  kable_styling(full_width = F)
```

### 3.2. Define never recertified surgeon group (Define NA group)

#### 3.2.1. At least 10 years after the initial certification year

The ABS require diplomats certified subsequently to pass a secure, multiple-choice comprehensive recertification examination in surgery every 10 years.

```{r}
abs_recert_na = abs_gs_2017 %>%
    # filter to NA 
    filter(is.na(ReCeverPassed)) %>%
    mutate(
    Gcertyear = as.numeric(Gcertyear),
    years_after_certification = 2019 - Gcertyear,
    years_after_certification = ifelse(is.na(years_after_certification),
                                         2019 - Gcompyear, Gcompyear)
  ) %>% 
  mutate(
    # years after initial recertification >10 years,
    # Defined NA that has failed the exam
    failed_recert_10yrs = ifelse(years_after_certification>10, "failed",
                           "not 10 yrs")
  )

# abs_recert_na %>% count(failed_recert_10yrs)

# find NA that had more than 10 years after the first certifification
failed_na = abs_recert_na %>% 
  filter(failed_recert_10yrs == "failed") 

# excluded surgeons
# abs_recert_na %>% 
#   filter(failed_recert_10yrs == "not 10 yrs") %>% nrow()
```

`r nrow(failed_na)` surgeons who had no recertification record but had initial board certification more than 10 years ago. We include this group as failed recertification group. Surgeons who didn't have 10 years after the initial certification process were excluded because they didn't have enough time to pass the re-certification exam.

#### 3.2.2 Grandfathered out of the recertification process

We excluded surgeons who had their initial certification before 1976. It was bases on the recertification was introduced at 1976 "the American Board of Surgery (ABS) introduced time-limited certification in 1976, requiring diplomats certified subsequently to pass...". If the surgeon was initially certified before 1976, she/he was not required for recertification at the initial certification time.

```{r}
failed_na = failed_na %>%
  mutate(
    residency_graduation_year = as.numeric(residency_graduation_year),
    older_surgeon = ifelse(residency_graduation_year < 1976,
                           "yes",
                           "no")
  )

qualified_na_failed_surgeons = failed_na %>%
  filter(older_surgeon == "no") %>%
  pull(npi)
```

`r nrow(failed_na)- length(qualified_na_failed_surgeons)` surgeons graduated before 1976 and are excluded in the analyses cohort. Below are the surgeon re-certification status after excluding the 10 years cutoff and grandfathered out surgeons.

```{r}
abs_w_recert = abs_gs_2017 %>%
  mutate(
    npi = as.character(npi),
    Recert_status = case_when(
      ReCeverPassed == 0 ~ "failed",
      ReCeverPassed == 1 ~ "passed",
      npi %in% qualified_na_failed_surgeons ~ "NA_failed"
    )
  ) %>%
  filter(!is.na(Recert_status))

abs_w_recert %>%
  count(Recert_status, name = "n suregon") %>%
  mutate(percentage = scales::percent(`n suregon` / sum(`n suregon`))) %>%
  kable() %>%
  kable_styling(full_width = F)

# nrow(abs_w_recert) #21273

# save(abs_w_recert, file = "/Volumes/George_Surgeon_Projects/MOC_vs_Outcome/data/abs/abs_w_recert.rdata")
```



## 4. Data linkage

### 4.1 Link Medicare data with ABS data by NPI

### 4.2 Only keep cases that performed between 10-20 years after initial certification*

The ABS gives 10 years for surgeons for the recertification. We keep cases that 10 years after the initial certification to better capture the impact of the recertification process. However, we excluded cases happened 20 years after the initial certification to elude the re-recertification effect,.e. only the first recertificastion cases were included in the cohort.


```{r, eval=FALSE}
# link abs with medicare
# library(data.table)
# library(tidyverse)
# 
# # medicare
# medicare = fread("/Volumes/George_Surgeon_Projects/standardized_medicare_data_using_R/analysis_ready_data/ecs_primary_surgeon_medicare2018.csv")
# 
# # abs
# load("/Volumes/George_Surgeon_Projects/MOC_vs_Outcome/data/abs/abs_w_recert.rdata")
# 
# abs_medicare = abs_w_recert %>%
#   inner_join(medicare, by = c("npi" = "id_physician_npi"))
# 
# # number of ABS surgeons who have no medicare record
# n_no_medicare_record = n_distinct(abs_w_recert$npi) - n_distinct(abs_medicare$npi)
# 
# abs_medicare_10_20yr = abs_medicare %>%
#   filter(facility_clm_yr - Gcertyear>10,
#          facility_clm_yr - Gcertyear<=20)
# 
# n_exclude_10_20 = n_distinct(abs_medicare$npi) - n_distinct(abs_medicare_10_20yr$npi)
# nrow(abs_medicare_10_20yr)
# 
# abs_medicare_npi = abs_medicare_10_20yr %>%
#   select(npi)
# 
# save(abs_medicare_10_20yr, file = "/Volumes/George_Surgeon_Projects/MOC_vs_Outcome/data/abs_medicare_10_20yr.rdata")
# save(abs_medicare_npi, file = "/Volumes/George_Surgeon_Projects/MOC_vs_Outcome/data/abs_medicare_npi.rdata")
# save(n_no_medicare_record, n_exclude_10_20, file="data/numbers_for_cohort_desp.RData")
```


```{r}
load("/Volumes/George_Surgeon_Projects/MOC_vs_Outcome/data/abs_medicare_npi.rdata")
# load("~/Documents/Repo/ABS_MoC_vs_pt_Outcome/data/numbers_for_cohort_desp.RData")
```


Link ABS with Medicare by NPI. Below is the number of surgeons by each recertification category after linked with Medicare outcomes.

```{r}
abs_w_recert %>%
  filter(npi %in% abs_medicare_npi$npi) %>%
  distinct(npi, Recert_status) %>%
  count(Recert_status, name = "n suregon") %>%
  mutate(percentage = scales::percent(`n suregon` / sum(`n suregon`))) %>%
  kable() %>%
  kable_styling(full_width = F)

n_lost = nrow(abs_w_recert) - n_distinct(abs_medicare_npi$npi)
perc = scales::percent(n_lost/nrow(abs_w_recert))
```

`r n_no_medicare_record` ABS surgeons don't have Medicare cases matched; `r n_exclude_10_20` surgeons don't have cases between 10 to 20 years after the initial certification.










