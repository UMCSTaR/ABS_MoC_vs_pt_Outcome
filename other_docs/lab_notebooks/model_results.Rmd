---
title: "Model Results"
author: "Xilin Chen"
date: "4/20/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  comment = NA,
  message = FALSE,
  warning = FALSE,
  R.options = list(width = 220),
  dev.args = list(bg = 'transparent'),
  dev = 'png',
  layout = "l-body-outset",
  fig.align = 'center',
  out.width = '75%',
  fig.asp = .75,
  fig.pos = 'H',
  cache = FALSE, 
  cache.rebuild = TRUE
)

library(tidyverse)
library(kableExtra)
library(broom.mixed)
library(lme4)
library(emmeans)
library(ggeffects)
```

## Death 30days

```{r, cache=TRUE}
load("/Volumes/George_Surgeon_Projects/MOC_vs_Outcome/model/death_model_bin.rdata")

# top 10 procedures
top10_all = read_csv("~/Documents/Repo/ABS_MoC_vs_pt_Outcome/data/top_10_all.csv")
top10_all_by_grp = read_csv("~/Documents/Repo/ABS_MoC_vs_pt_Outcome/data/top_10_by_grp.csv")
top10_f = top10_all_by_grp %>% filter(re_cert_bin== "Failed")
top10_p = top10_all_by_grp %>% filter(re_cert_bin== "Passed")
```

### Regression table

Fixed effect table
```{r}
tidy(death_model_bin) %>%
  filter(!str_detect(term, "sd")) %>% 
  transmute(term,
            estimate,
            OR = exp(estimate),
            p_value = round(p.value, 3)) %>% 
  kable() %>% 
  kable_styling(full_width = F)
```


### Fig1

```{r}
emmeans_cert = emmeans(death_model_bin,
                       ~ re_cert_bin,
                       type = "response",
                       data = death_model_bin@frame,
                        weights = "cells")

gg_dt = ggplot_build(plot(emmeans_cert))
gg_dt$data

plot(emmeans_cert) +
  scale_x_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.075)) +
  labs(y = "Re-certification status",
       x = "Probability",
       title = "Risk-adjusted mortality rate by recertification status") +
  coord_flip() +
  theme_classic()

# try emmeans
# rg <- ref_grid(death_model_bin)
# summary(rg) %>% glimpse()
# # compare probability (non-linear)
# pairs(emmeans_cert, reverse = T)
# # compare odds ratio (linear)
# pairs(emmeans(death_model_bin, ~ re_cert_bin), reverse = T, weights = "cells")

```

### by procedure

top10 most different procedures mortality outcomes by passed vs. failed surgeons

```{r}
re_proce = ggpredict(death_model_bin, terms = c("re_cert_bin", "procedure"), type = "random")

re_proce_diff_top10 = re_proce %>%
  pivot_wider(names_from = x,
              values_from = predicted) %>% 
  mutate(diff = Passed - Failed) %>% 
  arrange(-diff) %>% 
  head(10)


ggplot(re_proce %>% filter(group %in% re_proce_diff_top10$group),
       aes(x = reorder(group, predicted), y = predicted, fill = x)) +
  geom_bar(stat='identity', position='dodge') +
  coord_flip() +
  labs(title = "",
       x = "") +
  theme_bw() +
  theme(legend.position = "bottom")
  
```




